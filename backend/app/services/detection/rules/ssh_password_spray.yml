id: SSH_PASSWORD_SPRAY
name: SSH 密码喷洒
desc: >
  同一 src_ip 在 120 秒窗口内对多个不同 username 发生失败尝试（distinct username 数 ≥ 6），判定为密码喷洒攻击。
why: >
  密码喷洒特征是“同一来源 IP、尝试多账号、失败为主”；使用 distinct_on=username 统计去重用户数并设置冷却减少重复告警。
advice:
  - 先判定是否为误报：核对该 src_ip 是否为堡垒机/跳板机/监控探测器；若可信来源可加入白名单或提高阈值。
  - 若非可信来源，优先封禁该 src_ip 或对 SSH 进行限速（fail2ban/iptables/安全组），防止继续遍历账号。
  - 检查被尝试的账号列表：重点关注 root/admin/test/ubuntu/oracle 等常见账号，清理无用账号并禁用可疑账号。
  - 强化口令策略：提升复杂度与长度、禁止弱口令；对高权限账号启用 MFA 或仅允许密钥登录。
  - 限制暴露面：22 端口仅对运维网段开放；结合堡垒机/VPN，减少公网直接登录入口。
  - 追溯扩展威胁：查看同源 IP 是否还在进行端口扫描、Web 探测、目录爆破等；必要时联动 IDS/防火墙策略。
enabled: true
log_source: ssh
match:
  outcome: fail
group_by: [src_ip]
distinct_on: [username]
window_sec: 120
threshold: 6
severity: HIGH
cooldown_sec: 300
dedup_key: "{rule_id}:{src_ip}"
tags: [T1110.003, password_spraying]
require: [src_ip, username]
